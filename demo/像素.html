<!DOCTYPE html>
<html class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <style>
        canvas {
            display: inline-block;
            border: 1px solid rgb(119, 110, 110);
            color: #af9990;
            /* margin: 50px 200px ; */
        }

        body {
            margin: 0;
        }

        div {
            margin: 30px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div>
        <canvas id="canvas" width='400px' height='400px'>
            您的浏览器版本过低
        </canvas>
    </div>
    <div>
        <canvas id="canvas0" width='400px' height='400px'>
            您的浏览器版本过低
        </canvas>
    </div>
    <input id="color" value="" />
    <button id="btn">选择颜色</button>
    <button id="btn0">完成</button>
    <button id="btn1">产生数字</button>
    <script>









        /**
         * 
         * 注意点
         * 1、canvas要被一个单独的div嵌套，canvas作为唯一元素，且宽高相等
         * 2、为图画设置颜色时格式必须为‘#ffffff’的格式
         * 
         * 准备
         * var a = new Picture(arr);
         * a.init(context);
         * 
         * 初始化一个白色图片
         * a.initdata()
         * 
         * 初始化栅格
         * a.inittable()
         * 
         * 展示图画
         * a.draw(context); //context为canvas的2d环境
         * 
         * 去画
         * a.todraw(context);
         * 
         * 停止绘画
         * a.enddraw(context);
         * 
         * 撤回上一步
         * a.drawRecall(context)  //存在bug
         * 
         * 将图片转化为字符串用于存储于数据库
         * a.toString()
         * 
         * 图片用的颜色存于数组（白色永远为首位）
         * a.produceColorList
         * 
         * 生成颜色矩阵（矩阵中为数字，数字与a.produceColorList中颜色的下标相对应）
         * a.createNumberData
         * 
         * 绘制数字（白色即0除外）
         * a.drawNumber
         * 
         */




        function Picture(drawDataMatrix) {
            this.drawDataMatrix = drawDataMatrix || [];//画的存储矩阵
            this.history = [];
            this.color = '#ffffff';
            this.numberDataMatrix = [];
            this.colorList = ["#ffffff"];
        }
        Picture.prototype.initdata = function () {
            for (var i = 0; i < 400; i++) {
                // arr.push('#' + Math.random().toString(16).slice(-6));
                this.drawDataMatrix.push("#ffffff");
            }
        }
        Picture.prototype.inittable = function (context) {
            //绘制网格
            for (var i = 0; i <= context.canvas.width / 20; i++) {
                context.beginPath();
                context.moveTo(20 * i, 0);
                context.lineTo(20 * i, context.canvas.height);
                context.strokeStyle = 'red';
                context.stroke();
                context.closePath();
            }
            for (var i = 0; i <= context.canvas.width / 20; i++) {
                context.beginPath();
                context.moveTo(0, 20 * i);
                context.lineTo(context.canvas.width, 20 * i);
                context.strokeStyle = 'red';
                context.stroke();
                context.closePath();
            }
        }
        Picture.prototype.draw = function (context) {
            var n = 0;
            // console.log(this.drawDataMatrix);
            // console.log(context);
            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 20; j++) {
                    context.beginPath();
                    context.fillStyle = this.drawDataMatrix[n];
                    context.fillRect(j * 20, i * 20, 20, 20)
                    context.closePath();
                    n++;
                }
            }



        }
        Picture.prototype.todraw = function (context) {
            context.canvas.addEventListener("click", this.event = (e) => {
                // console.log(e.offsetX,e.offsetY);
                console.log("click");
                var row = Math.floor((e.offsetX) / 20);//列
                var col = Math.floor((e.offsetY) / 20);//排
                var n = col * 20 + row;
                this.drawDataMatrix[n] = this.color;
                context.fillStyle = this.color;
                context.fillRect(row * 20, col * 20, 20, 20);


            }, false)
            context.canvas.addEventListener("mousedown", (e) => {
                console.log("mousedown");
                var row = Math.floor((e.offsetX) / 20);//列
                var col = Math.floor((e.offsetY) / 20);//排
                var n = col * 20 + row;
                this.drawDataMatrix[n] = this.color;
                context.fillStyle = this.color;
                context.fillRect(row * 20, col * 20, 20, 20);
                this.timer = setTimeout(() => {
                    console.log("1s到");
                    context.canvas.addEventListener("mousemove", this.mousemoveEvent = (e) => {
                        console.log("触发了滑动事件");
                        var row = Math.floor((e.offsetX) / 20);//列
                        var col = Math.floor((e.offsetY) / 20);//排
                        var n = col * 20 + row;
                        this.drawDataMatrix[n] = this.color;
                        context.fillStyle = this.color;
                        context.fillRect(row * 20, col * 20, 20, 20)
                    })

                }, 1000)
            })
            context.canvas.addEventListener("mouseup", (e) => {
                console.log("松开");
                clearTimeout(this.timer);
                context.canvas.removeEventListener("mousemove", this.mousemoveEvent, false);
                // var arr=[...this.drawDataMatrix];
                // this.history.push([...this.drawDataMatrix]);
                // console.log(this.drawDataMatrix);
                // console.log(this.history)
            })
            context.canvas.addEventListener("touchstart", (e) => {
                this.timer = setTimeout(() => {
                    context.canvas.addEventListener("touchmove", this.touchmoveEvent = (e) => {
                        console.log("touchmove");
                        e.offsetX = e.touches[0].clientX - e.srcElement.offsetLeft;
                        e.offsetY = e.touches[0].clientY - e.srcElement.offsetTop;
                        var row = Math.floor((e.offsetX) / 20);//列
                        var col = Math.floor((e.offsetY) / 20);//排
                        var n = col * 20 + row;
                        this.drawDataMatrix[n] = this.color;
                        context.fillStyle = this.color;
                        context.fillRect(row * 20, col * 20, 20, 20)
                    })

                }, 1000)
            })
            context.canvas.addEventListener("touchend", () => {
                clearTimeout(this.timer);
                context.canvas.removeEventListener("touchmove", this.touchmoveEvent, false)
                // console.log(this.history);
                // var arr=[...this.drawDataMatrix];
                // this.history.push([...this.drawDataMatrix]);
                // console.log(this.history);
            })

        }
        Picture.prototype.enddraw = function (context) {
            context.canvas.removeEventListener("click", this.event, false)
        }
        Picture.prototype.drawRecall = function (context) {
            //删除尾部元素
            this.history.pop();
            this.drawDataMatrix = this.history[this.history.length - 1];
            this.draw(context);
            // this.todraw(context);
            this.inittable(context);
        }
        Picture.prototype.toString = function () {
            var str = '';
            for (var i = 0; i < this.drawDataMatrix.length; i++) {
                str += this.drawDataMatrix[i];
            }
            return str
        }

        //先具有颜色列表，在根据颜色列表对应数字填满数字矩阵，在根据数字矩阵绘出数字
        Picture.prototype.produceColorList = function () {
            let isExist = false;
            for (let i = 0; i < this.drawDataMatrix.length; i++) {
                isExist = false;
                for (let j = 0; j < this.colorList.length; j++) {
                    if (this.colorList[j] == this.drawDataMatrix[i]) {
                        isExist = true;
                        break;
                    }
                }
                if (!isExist) {
                    console.log("存储颜色" + this.drawDataMatrix[i]);
                    this.colorList.push(this.drawDataMatrix[i])
                }
            }
            return this.colorList;
        }
        Picture.prototype.createNumberData = function () {
            for (let i = 0; i < this.drawDataMatrix.length; i++) {
                for (let j = 0; j < this.colorList.length; j++) {
                    if (this.drawDataMatrix[i] == this.colorList[j]) {
                        this.numberDataMatrix[i] = j;
                        break;
                    }
                }
            }
            return this.numberDataMatrix;
        }
        Picture.prototype.drawNumber = function (context) {
            var n = 0;
            context.font = '14px Arial';
            context.fillStyle = "rgb(119, 110, 110)";
            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 20; j++) {
                    if(this.numberDataMatrix[n]==0){
                        n++;
                        continue;
                    }
                    context.beginPath();
                    context.fillText(this.numberDataMatrix[n], j * 20+5, i * 20+15);
                    context.closePath();
                    n++;
                }
            }
        }


        function main() {

            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");
            var canvas0 = document.getElementById("canvas0");
            var context0 = canvas0.getContext("2d");
            var arr = [];
            for (var i = 0; i < 400; i++) {
                // arr.push('#' + Math.random().toString(16).slice(-6));
                arr.push("#ffffff");
            }
            var btn = document.getElementById("btn");
            btn.onclick = () => {
                a.color = document.getElementById("color").value;
            }
            var btn0 = document.getElementById("btn0");
            btn0.onclick = () => {
                b.drawDataMatrix = a.drawDataMatrix;
                b.draw(context0);
            }
            var btn1 = document.getElementById("btn1");
            btn1.onclick = () => {
                console.log("数字");
                console.log(a.produceColorList());
                console.log(a.createNumberData());
                a.drawNumber(context);
            }

            var b = new Picture();
            b.inittable(context0);

            var a = new Picture();
            a.initdata();
            a.inittable(context);
            a.todraw(context);

        }
        main();


    </script>
</body>

</html>